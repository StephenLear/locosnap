# Handover — 2026-02-17

## Status
Full monetization pipeline wired up: Supabase migration, RevenueCat, App Store Connect (products, subscriptions, listing, screenshots). iOS app nearly ready for App Store submission. Two code fixes shipped.

## What Was Done

### Supabase
- Ran migration `004_blueprint_credits.sql` via SQL Editor
- Added `blueprint_credits` column to `profiles` table
- Created `credit_transactions` table with RLS policies and indexes

### RevenueCat
- Created RevenueCat project "locosnap" (category: Entertainment, platform: React Native)
- Added iOS app (App Store) — API key: `appl_lHzQMstHbaaiEvpUuNTjgREqSTj`
- Added Android app (Play Store) — API key: `goog_CtioDXmtAOkzfQqddCaOQhJebMb`
- Connected In-App Purchase .p8 key (Key ID: `2979LJN27D`) and App Store Connect API key (Key ID: `7SZTP5A76J`)
- Entitlement: `pro` (linked to both subscription products)
- **Default offering** (Pro subscription):
  - Monthly package → `pro_monthly` (£2.99/month)
  - Yearly package → `pro_annual` (£24.99/year)
  - Lifetime package (empty — no product attached)
- **Blueprint credits offering** (`blueprint_credits`):
  - `blueprint_1_credit` — custom package → £0.99
  - `blueprint_5_credits` — custom package → £3.99
  - `blueprint_10_credits` — custom package → £5.99
- Webhook configured: `https://locosnap.onrender.com/api/webhooks/revenuecat` with `Bearer loco-webhook-secret-2026` auth header, both production + sandbox events, all apps, all event types

### App Store Connect
- Created app record: "Locosnap", Bundle ID `com.locosnap.app`, SKU `locosnap`
- Registered Bundle ID on Apple Developer Portal (Identifiers)
- **3 consumable in-app purchases**: `blueprint_1_credit` (£0.99), `blueprint_5_credits` (£3.99), `blueprint_10_credits` (£5.99)
- **2 auto-renewable subscriptions** in group "LocoSnap Pro": `pro_monthly` (£2.99), `pro_annual` (£24.99)
- Categories: Entertainment (primary), Reference (secondary)
- Age rating: 4+ (all None/No)
- App Privacy: published (photos, contact info, identifiers, usage data, diagnostics, purchases)
- App description, promotional text, keywords all filled in
- Support URL: `https://stephenlear.github.io/locosnap/support.html`
- Marketing URL: `https://stephenlear.github.io/locosnap/`
- Screenshots uploaded for 6.3" display (iPhone 16 Pro), subscriptions page, and in-app purchase page

### GitHub Pages
- Created and deployed: landing page (`index.html`), support page (`support.html`), privacy policy (`privacy.html`)
- Repo made public to enable GitHub Pages (free tier)
- Live at `https://stephenlear.github.io/locosnap/`

### Code Changes
- **card-reveal.tsx**: Added close button (✕) top-right to navigate back to home. Fixed share button with text fallback when image capture fails in Expo Go.
- **sign-in.tsx**: Fixed OTP length from 7 to 8 digits to match Supabase project config. Updated placeholder to `00000000`.
- **frontend/.env**: Added `EXPO_PUBLIC_REVENUECAT_IOS_KEY` and `EXPO_PUBLIC_REVENUECAT_ANDROID_KEY` (gitignored, not committed)

### Commits This Session
- `2f87f32` — Add landing page, support page, and privacy policy for App Store
- `f159d93` — Fix card reveal UX and sign-in OTP length

## What Worked
- RevenueCat auto-imported all 3 consumable products from App Store Connect (saved manual entry)
- Existing `REVENUECAT_WEBHOOK_SECRET` was already on Render (`loco-webhook-secret-2026`)
- Expo SDK 54 defaults to Xcode 26 / iOS 26 SDK — no config changes needed for the April 2026 deadline
- iPhone 16 Pro screenshots accepted by App Store Connect without issues

## What Didn't Work (and Fixes)
- **OTP length mismatch**: Code had `OTP_LENGTH = 7` but Supabase sends 8-digit codes. Fixed to 8.
- **Card reveal trapped**: No back/close button — user couldn't return to home screen. Added close button.
- **Share button silent fail**: `captureRef` doesn't work in Expo Go. Added try/catch with text-only fallback.
- **GitHub Pages on private repo**: Free tier doesn't support Pages on private repos. Made repo public.
- **RevenueCat default offering had test products**: Auto-generated "Monthly", "Yearly", "Lifetime" were Test Store products. Had to manually replace with real `pro_monthly` and `pro_annual`.
- **App Store Connect required .p8 key for RevenueCat**: Had to locate existing In-App Purchase key (Key ID: `2979LJN27D`) on Mac and upload.

## Key Decisions
- **£0.99 per blueprint credit**: Apple's minimum tier. Originally planned £0.49 but App Store doesn't allow it.
- **£2.99/month, £24.99/year for Pro**: Annual gives ~30% saving vs monthly (£24.99 vs £35.88).
- **Entertainment + Reference categories**: Best fit for a hobby/collection app with educational content.
- **Repo made public**: Required for free GitHub Pages hosting. Code is now visible.
- **iOS first**: Focusing on getting iOS fully working before setting up Google Play Console.

## Important Credentials (for reference)
| Key | Value |
|-----|-------|
| RevenueCat iOS API Key | `appl_lHzQMstHbaaiEvpUuNTjgREqSTj` |
| RevenueCat Android API Key | `goog_CtioDXmtAOkzfQqddCaOQhJebMb` |
| RevenueCat Webhook Secret | `loco-webhook-secret-2026` (on Render) |
| Apple Bundle ID | `com.locosnap.app` |
| Apple SKU | `locosnap` |
| Apple App ID | `6759280267` |
| In-App Purchase Key ID | `2979LJN27D` |
| App Store Connect API Key ID | `7SZTP5A76J` |
| Issuer ID | `4291e037-c269-48a4-b140-40563fa2f764` |
| Vendor Number | (check Business tab in App Store Connect) |

## Next Steps (Prioritized)
1. **EAS build + TestFlight** — Build with `eas build --platform ios --profile production`, then submit to TestFlight for real device testing with RevenueCat purchases.
2. **Sandbox test purchases** — Test Pro subscription and blueprint credit purchases in sandbox mode via TestFlight.
3. **Add review screenshots for IAPs** — Each in-app purchase and subscription needs a review screenshot before App Store submission (currently showing "missing metadata").
4. **Google Play Console setup** — Create app record, add same 5 products (3 consumable + 2 subscription), link to RevenueCat Android app.
5. **App Store submission** — Once sandbox testing passes, submit for App Store review.
6. **Update `eas.json` submit config** — Replace placeholder Apple ID and ASC App ID with real values (`ascAppId: "6759280267"`).

## Important Files
| File | Role |
|------|------|
| `frontend/.env` | Has Supabase + RevenueCat keys (gitignored) |
| `frontend/services/purchases.ts` | RevenueCat SDK wrapper — init, offerings, purchase, restore |
| `frontend/app/paywall.tsx` | Paywall UI — Pro subscriptions + blueprint credit purchase |
| `frontend/app/card-reveal.tsx` | Card reveal — now has close button + share fallback |
| `frontend/app/sign-in.tsx` | Sign-in — OTP length fixed to 8 |
| `backend/src/routes/webhooks.ts` | RevenueCat webhook handler — grants Pro + adds credits |
| `backend/src/routes/credits.ts` | Blueprint credit deduction + balance endpoints |
| `supabase/migrations/004_blueprint_credits.sql` | Migration — already run |
| `docs/index.html` | Landing page (GitHub Pages) |
| `docs/support.html` | Support page (GitHub Pages) |
| `docs/privacy.html` | Privacy policy (GitHub Pages) |
| `frontend/eas.json` | EAS config — submit section needs real Apple ID + ASC App ID |

## Context for Next Session
- **Node version**: Use Node 20 via nvm (`nvm use 20`). Node 24 breaks jest-expo and react-native-purchases.
- **Expo SDK**: 54 with Xcode 26 default on EAS Build — meets April 2026 iOS SDK requirement.
- **Backend**: Deployed at `https://locosnap.onrender.com` (free tier, may sleep after inactivity).
- **RevenueCat dashboard**: `https://app.revenuecat.com/projects/a90c6f7d`
- **The `.env` file is gitignored** — RevenueCat keys are only in the local file, not committed.
- **Supabase rate limits**: OTP sends are limited per hour. If testing sign-in, be patient between attempts.
- **App Store status**: "1.0 Prepare for Submission" — all metadata filled except IAP review screenshots.
