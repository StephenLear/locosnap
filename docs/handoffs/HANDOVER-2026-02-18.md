# Handover — 2026-02-18

## Status
Build 16 submitted to TestFlight and App Store review submitted. Blueprint viewer fix applied — dynamic aspect ratio detection via `Image.getSize()`. Still "not 100%", technical style whitespace issue remains under investigation. App is in App Store review.

## What Was Done
- **Blueprint viewer fix**: Replaced hardcoded `9/16` aspect ratio with `Image.getSize()` to detect real image dimensions before rendering
- **Suppressed flash**: Image now withheld from render until `getSize` resolves — loading spinner shown throughout, no jump from wrong to correct size
- **PR #1 opened, merged**: `fix/blueprint-dynamic-aspect-ratio` branch — all tests passing (93/93)
- **Preview CI fixed**: Changed `--platform all` to `--platform ios` in preview workflow, then disabled auto-trigger entirely (`workflow_dispatch` only) because internal distribution credentials not set up on Expo servers
- **EXPO_TOKEN secret**: Added to GitHub repo secrets — auth now works in CI
- **Git divergence resolved**: Force-pushed to resolve local/remote divergence after PR merge caused conflicts with old ScrollView commits in history
- **Builds 13–16 submitted to TestFlight**: Builds 13–15 wasted due to file revert issue (see Lessons Learned). Build 16 is the correct one.
- **Build 16 submitted for App Store review**: User to complete at appstoreconnect.apple.com/apps/6759280267

## What Worked
- `Image.getSize()` correctly detects real dimensions for vintage and schematic styles — both now display fully without cropping
- `workflow_dispatch` only trigger cleanly stops the CI noise from preview build failures
- `git push --force-with-lease` resolved the diverged history cleanly
- 93/93 tests passing throughout — no regressions

## What Didn't Work (and Fixes)
- **Hardcoded `9/16` aspect ratio**: DALL-E 3 / Replicate don't always return exactly 9:16 — different styles produce different actual dimensions → **Fix**: `Image.getSize()` + suppress render until resolved
- **Flash of wrong size on first render**: Even with `getSize`, the 9:16 fallback rendered first causing a visible jump → **Fix**: Don't render image at all until `imageDimensions` state is populated
- **Preview CI `--platform all`**: Android requires interactive Keystore setup, fails non-interactively → **Fix**: Changed to `--platform ios`, then disabled auto-trigger entirely
- **Preview CI `EXPO_TOKEN` missing**: Auth failed on first run → **Fix**: Token added to GitHub repo secrets at github.com/StephenLear/locosnap/settings/secrets/actions
- **Local file silently reverted**: After PR merge, `blueprint.tsx` locally reverted to old hardcoded 9:16 version. Builds 13, 14, 15 compiled the wrong file — 3 wasted paid builds → **Fix**: Reapplied fix manually, used `git diff` to verify before build 16
- **Git non-fast-forward push**: After force-push merge of PR, local main was behind remote → **Fix**: `git push --force-with-lease` after confirming our commit was correct

## Key Decisions
- **`Image.getSize()` over `onLoad` event for dimensions**: `getSize` is a HEAD request that resolves before the image body downloads, so dimensions are known before the image renders. `onLoad` fires after render — too late to prevent wrong initial sizing.
- **Suppress render until dimensions known**: Simpler and more robust than trying to resize after first render. Loading spinner covers the wait (usually <1s).
- **Disable preview CI entirely**: No internal distribution credentials configured, no Android Keystore, and builds are done manually anyway — the workflow was purely noise.
- **`--force-with-lease` not `--force`**: Safer force push — fails if remote has commits you haven't seen locally, preventing accidental overwrites.

## Lessons Learned & Gotchas
- **CRITICAL: Always `git diff <file>` before triggering a build.** After a PR merge, local files can silently be at an older version than expected. This caused 3 wasted paid builds (13, 14, 15) in this session. Mandatory pre-build check: `git diff frontend/app/blueprint.tsx` + `git log --oneline -3`.
- **Local branch diverges silently after PR merge**: When a PR is squash-merged on GitHub, the remote `main` moves forward but local `main` stays behind. Always `git pull` or `git fetch` before any work after a merge.
- **EAS build credits**: At 100% monthly limit — every build is charged at pay-as-you-go rates. Currently on build 16. Each wasted build = real money.
- **DALL-E 3 ignores aspect ratio prompts**: Even though all style prompts include "Aspect Ratio: 9:16", DALL-E 3 generates at its own interpretation. Replicate SDXL is more obedient but still not guaranteed. Never assume a fixed aspect ratio.
- **`overflow: "hidden"` on imageArea clips dynamic resizes**: If image size changes after first render, the clip prevents seeing the full image. The suppress-until-ready approach avoids this entirely.
- **GitHub Linguist language detection**: Driven by tracked file count ratio. LocoSnap correctly shows TypeScript. Coverage folders aren't tracked (already gitignored).
- **EAS preview profile = internal distribution**: Requires a separate Ad Hoc / internal distribution certificate, not the same as App Store distribution. Not set up on Expo servers for this project.

## Next Steps (Prioritized)
1. **Fix technical style whitespace**: The technical blueprint still shows white space above/below the image — the generated image appears to have a wide/landscape crop with the train not filling the canvas. Root cause is likely the AI generating a landscape-ish composition inside a portrait canvas, leaving dead space. Options: (a) adjust the technical style prompt to force tighter composition, (b) add CSS `object-fit: cover` style cropping as a user option, (c) accept as AI limitation
2. **App Store review outcome**: Monitor for reviewer feedback. Common rejection reasons to watch: missing `NSPhotoLibraryAddUsageDescription` (for save-to-gallery), RECORD_AUDIO permission not justified (from expo-camera)
3. **Add `NSPhotoLibraryAddUsageDescription`** to `app.json` infoPlist if App Store review flags it: `"NSPhotoLibraryAddUsageDescription": "LocoSnap saves blueprint images to your photo library."`
4. **Zoom hint**: Consider adding a "Pinch to zoom" label that fades after 2 seconds — discoverability improvement for the gesture viewer
5. **Monitor Render cold-start 500s**: User reported a one-time 500 on `/api/identify` in earlier session (likely Render cold start). If it recurs, add retry logic or keep-alive ping

## Important Files
| File | Role |
|------|------|
| `frontend/app/blueprint.tsx` | Blueprint viewer — **core file for this session**. Contains `Image.getSize()` fix, `imageDimensions` state, suppress-until-ready render pattern, pinch-to-zoom/pan/double-tap gestures |
| `frontend/app/_layout.tsx` | Root layout — `GestureHandlerRootView` wraps entire app (required for gesture handler) |
| `frontend/app/results.tsx` | Results screen — blueprint button states, style picker, credit flow (unchanged this session) |
| `backend/src/services/imageGen.ts` | Blueprint generation — Replicate SDXL (768x1344) and DALL-E 3 (1024x1792) — different actual dimensions per provider |
| `.github/workflows/preview.yml` | Preview CI — **disabled** (workflow_dispatch only). Was causing CI failures on every PR. |
| `.github/workflows/ci.yml` | Main CI — backend + frontend tests on push. Working correctly. |
| `frontend/eas.json` | EAS config — `autoIncrement: true`, production env vars, Apple ID/ASC App ID for submit |
| `frontend/app.json` | Expo config — bundle ID `com.locosnap.app`, infoPlist permissions |

## Context for Next Session
- **Current build**: v1.0.0, buildNumber 16, submitted to App Store review on 2026-02-18
- **TestFlight**: Build 16 available at appstoreconnect.apple.com/apps/6759280267/testflight/ios
- **EAS build credits**: 100% used for month — all further builds are pay-as-you-go
- **Git state**: `main` branch, clean, up to date with remote. Force-pushed to resolve divergence.
- **Blueprint viewer aspect ratios in practice**:
  - Replicate SDXL: requests 768x1344 (exactly 9:16) — but AI may leave dead space
  - DALL-E 3: requests 1024x1792 (≈4:7, close to 9:16) — AI ignores composition guidance
  - Vintage and schematic: working well in build 16
  - Technical: still shows whitespace — likely an AI generation issue not a viewer issue
  - Cinematic: always worked (vivid style fills frame)
- **Key dependencies**: `react-native-gesture-handler` v2.28.0, `react-native-reanimated` v4.1.6, `expo-screen-orientation` v9.0.8
- **EXPO_TOKEN**: Set in GitHub repo secrets — preview CI auth now works if re-enabled
- **Render backend**: Live at https://locosnap.onrender.com — watch for cold start 500s on first request after inactivity
- **Revenue Cat, Supabase, PostHog**: All configured and working
- **Pre-build checklist for next session**:
  1. `git status` — confirm clean working tree
  2. `git diff frontend/app/blueprint.tsx` — verify change is in the file
  3. `git log --oneline -3` — confirm correct commit at HEAD
  4. Only then: `eas build --platform ios --profile production --non-interactive`
