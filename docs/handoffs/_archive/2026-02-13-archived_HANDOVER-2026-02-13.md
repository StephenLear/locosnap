# Handover — 2026-02-13

## Status
V2 fully complete. All features shipped: Pro subscriptions (RevenueCat), blueprint styles, collection comparisons, advanced filters & search. Two commits this session: `aaf1a17` and `d5e6355`.

## What Was Done

### Phase 1: V2 Pro Subscriptions (commit `aaf1a17`)
- Wired `webhooksRouter` into `backend/src/index.ts` (import + route + startup banner)
- Verified all analytics events present across codebase (paywall_viewed, purchase_started/completed/failed/restored, subscription_event)
- Updated `docs/PRODUCT-SPEC.md` — marked Pro subscription as DONE
- Committed 18 files as `aaf1a17`: "Add Pro subscriptions via RevenueCat (V2)"

### Phase 2: Remaining V2 Features (commit `d5e6355`)

**Pro Blueprint Styles (backend):**
- Added `BlueprintStyle` type to `backend/src/types/index.ts`
- Added `STYLE_PROMPTS` record with 4 styles to `backend/src/services/imageGen.ts` (technical, vintage, schematic, cinematic) — each with `design` and `vibe` prompt sections
- Updated `buildBlueprintPrompt()` and `startBlueprintGeneration()` to accept style param
- Updated `backend/src/services/trainCache.ts` — added `blueprintUrls?: Record<string, string>` for style-keyed caching alongside legacy `blueprintUrl`
- Updated `backend/src/routes/identify.ts` — extracts/validates `blueprintStyle` from request body, passes through pipeline

**Pro Blueprint Styles (frontend):**
- Added `BlueprintStyle` type and `BLUEPRINT_STYLES` constant to `frontend/types/index.ts`
- Updated `frontend/services/api.ts` — `identifyTrain()` accepts and sends `blueprintStyle` via FormData
- Updated `frontend/store/trainStore.ts` — added `selectedBlueprintStyle` and `setBlueprintStyle` state/action
- Updated `frontend/app/(tabs)/index.tsx` — reads selected style from store, passes to API
- Updated `frontend/app/results.tsx` — horizontal ScrollView style picker with Pro gating (lock icon, paywall redirect)

**Advanced Filters & Search:**
- Updated `frontend/app/(tabs)/history.tsx`:
  - Text search bar (searches class, operator, name, type — case-insensitive)
  - Builder filter chips (dynamic from history data)
  - "Has Blueprint" Switch toggle
  - All integrated into existing `filteredHistory` useMemo

**Collection Comparisons:**
- Created `frontend/app/compare.tsx` — side-by-side spec comparison screen
  - `parseNumeric()` extracts numbers from spec strings like "125 mph"
  - `compareValues()` determines winner per row
  - `CompRow` component highlights winner in accent colour
  - Full spec table: speed, power, weight (lower=better), length, builder, year, gauge, fuel, built, surviving, status
- Updated `frontend/app/(tabs)/history.tsx` — compare mode: toggle, select 2 trains, floating "Compare" button
- Updated `frontend/app/_layout.tsx` — added `<Stack.Screen name="compare" />`
- Updated `frontend/store/trainStore.ts` — added `compareItems` state and `setCompareItems` action

**Product Spec + Commit:**
- Updated `docs/PRODUCT-SPEC.md` — marked all 3 remaining V2 items as DONE
- Committed 13 files (982 insertions) as `d5e6355`

## What Worked
- Plan file at `~/.claude/plans/warm-humming-codd.md` kept implementation focused across session continuations
- Style-keyed caching design (`blueprintUrls` map + legacy `blueprintUrl` field) gives backwards compatibility without migration
- Client-side filtering approach means zero backend changes for search/filter features
- Parameterized prompt engineering via `STYLE_PROMPTS` record keeps style definitions clean and extensible

## What Didn't Work (and Fixes)
- **Line number prefix in edit string**: Accidentally included `84->` prefix from Read output in an `old_string` edit for `index.ts` startup banner. Fixed by removing the prefix.
- **"File has not been read yet" errors**: Hit this multiple times when trying to Edit `trainCache.ts` and `history.tsx` without reading them first in the current context window. Fixed by always reading the file before editing. This is a recurring pattern — always read before edit after context compaction.

## Key Decisions
- **Style-keyed cache design**: Used `blueprintUrls?: Record<string, string>` alongside legacy `blueprintUrl` field. The `getCachedTrainData` checks style-specific map first, falls back to legacy for "technical" style. This avoids any data migration.
- **Style validation on backend**: Added `VALID_STYLES` array in identify.ts to whitelist valid styles, defaulting to "technical" if invalid/missing. Prevents prompt injection via style param.
- **Compare mode UX**: Two-phase flow — toggle compare mode in toolbar -> select 2 cards (checkbox overlay, max 2) -> floating "Compare" button appears -> navigates to `/compare` with items in Zustand store.
- **All filtering client-side**: Search, builder filter, blueprint toggle all run in `useMemo` on the existing `history[]` array. No backend endpoints needed.

## Lessons Learned & Gotchas
- After context compaction, always Read a file before trying to Edit it — the "already read" state doesn't survive compaction
- The `STYLE_PROMPTS` record pattern (keyed by style, with sub-fields) is clean and easy to extend with new styles later
- Blueprint cache key is still `"class::operator"` — the style is handled at the field level inside the cache entry, not in the key
- `compare.tsx` uses `parseNumeric()` to extract numbers from spec strings like "125 mph" or "2,000 hp" — handles commas, decimals, and units

## Next Steps (Prioritized)
1. **App Store preparation** — screenshots, App Store listing copy, TestFlight build
2. **Testing pass** — manual QA of all V2 features (style picker, compare mode, search/filters)
3. **Blueprint style visual QA** — generate sample blueprints in all 4 styles, verify prompt quality
4. **Consider V3 features** — the product spec currently ends at V2, could plan: map view of spots, social sharing of collections, trade/gift cards between users
5. **Production hardening** — replace in-memory blueprint task store with Redis, add rate limiting to identify endpoint

## Important Files
| File | Role |
|------|------|
| `backend/src/services/imageGen.ts` | Blueprint generation — 4 style prompts, Replicate SDXL / DALL-E 3 |
| `backend/src/services/trainCache.ts` | Style-keyed blueprint cache with backwards compat |
| `backend/src/routes/identify.ts` | Main identify endpoint — validates style, passes through pipeline |
| `backend/src/types/index.ts` | Backend shared types incl. `BlueprintStyle` |
| `frontend/app/compare.tsx` | NEW — side-by-side train spec comparison screen |
| `frontend/app/(tabs)/history.tsx` | Collection screen — search, filters, compare mode |
| `frontend/app/results.tsx` | Results screen — blueprint style picker UI |
| `frontend/app/_layout.tsx` | Root layout — added compare Stack.Screen |
| `frontend/store/trainStore.ts` | Zustand store — `selectedBlueprintStyle`, `compareItems` |
| `frontend/types/index.ts` | Frontend types — `BlueprintStyle`, `BLUEPRINT_STYLES` constant |
| `frontend/services/api.ts` | API client — `identifyTrain()` sends `blueprintStyle` |
| `docs/PRODUCT-SPEC.md` | Product spec — all V1 through V2 marked DONE |
| `~/.claude/plans/warm-humming-codd.md` | Implementation plan for V2 remaining features |

## Context for Next Session
- **All V2 features are shipped.** The product spec (`docs/PRODUCT-SPEC.md`) has everything through V2 marked DONE.
- **Git state**: clean working tree on `main`, latest commit `d5e6355`.
- **No tests exist yet** — the project has been built in rapid prototype mode. A testing pass would be valuable before App Store submission.
- **Blueprint task store is in-memory** (`Map<string, BlueprintTask>` in imageGen.ts) — fine for dev, needs Redis for production.
- **The plan file** at `~/.claude/plans/warm-humming-codd.md` is now complete and can be archived.
- **RevenueCat webhook** is wired but needs the actual RevenueCat dashboard configured with the webhook URL pointing to `/api/webhooks/revenuecat`.
