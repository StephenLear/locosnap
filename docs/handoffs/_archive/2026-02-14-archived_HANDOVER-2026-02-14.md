# Handover — 2026-02-14

## Status
Hardening plan 100% complete — all 27 tasks done. 92 tests across 14 suites (backend + frontend), Redis blueprint store, GitHub Actions CI/CD, and CLAUDE.md housekeeping all shipped.

## What Was Done
- **Backend tests (53 tests, 11 suites):** vision, trainSpecs, trainFacts, rarity, imageGen, trainCache, redis, analytics services + identify, imageStatus, webhooks routes
- **Redis blueprint task store:** Replaced in-memory `Map<string, BlueprintTask>` with ioredis + Upstash Redis, falling back to in-memory when `REDIS_URL` is empty
- **Frontend tests (39 tests, 3 suites):** compare utils (16 tests), trainStore Zustand state (11 tests), API client service (12 tests)
- **Extracted `frontend/utils/compare.ts`** from `app/compare.tsx` for testability
- **GitHub Actions CI/CD:** `ci.yml` (backend tsc + jest, frontend jest on every push) + `preview.yml` (EAS preview builds on frontend PRs)
- **CLAUDE.md rewrite:** CarSnap -> LocoSnap with accurate project structure, endpoints, testing docs

## What Worked
- **ts-jest preset with `testEnvironment: "node"`** for frontend — avoids all React Native / Expo native module issues while still testing pure business logic (stores, services, utils)
- **Fixture factories** (`makeTrain()`, `makeSpecs()`, etc.) — clean, DRY test setup across all backend test files
- **Supertest integration tests** for Express routes — caught real issues with type assertions
- **Redis in-memory fallback pattern** — production uses Upstash, dev uses Map, tests use in-memory via `jest.resetModules()`

## What Didn't Work (and Fixes)
- **`imageGen.ts` TS2352:** `(output as string)` failed because `output` is an object -> Fixed with `(output as unknown as string)` double cast
- **`imageStatus.ts` TS2345:** `req.params.taskId` typed as `string | string[]` -> Fixed with `const taskId = req.params.taskId as string`
- **jest-expo 54 + Jest 30 + Node 24 incompatibility:** `Object.defineProperty called on non-object` in jest-expo setup.js -> Abandoned jest-expo entirely, switched to `ts-jest` preset with `testEnvironment: "node"` for pure logic tests
- **Jest 29 + `.ts` config:** Jest 29 can't parse `.ts` config files without ts-node -> Switched to `jest.config.js` (plain JS)
- **`setupFilesAfterSetup`:** Wrong Jest config key -> Correct key is `setupFilesAfterEnv`
- **trainStore test import chain:** Importing trainStore pulls in supabase -> expo-file-system (ESM native module) -> Fixed by adding comprehensive `jest.mock()` calls at top of test file for all deep dependencies (AsyncStorage, expo-file-system, base64-arraybuffer, config/supabase, services/supabase, notifications, analytics, authStore)
- **API `pollBlueprintStatus` cancel test timeout:** Mock `get` that never resolves meant `cancel()` couldn't trigger the `cancelled` flag check -> Fixed by mocking `get` to return "processing" status so the poll loop continues, then cancelling between polls and asserting no further polling occurs

## Key Decisions
- **Pure logic tests only (no RN rendering):** jest-expo is too fragile on Node 24. Testing utils/stores/services covers the important business logic without fighting the RN test environment
- **Redis with in-memory fallback:** Not a hard dependency — app works identically without Redis, just uses Map. This means zero friction for local dev
- **Removed `cleanupOldTasks`:** Redis TTL (1 hour) handles expiry automatically, simplifying the codebase
- **`getTaskStatus` made async:** Breaking change to callers (imageStatus route, identify route) but necessary for Redis. All callers updated to `await`
- **Node 20 in CI:** Pinned to Node 20 in GitHub Actions since Node 24 has compatibility issues with jest-expo

## Lessons Learned & Gotchas
- **jest-expo + Node 24 = broken:** The `jest-expo/src/preset/setup.js` file calls `Object.defineProperty` on `NativeModules.default` which is `undefined` on Node 24. Don't try to use jest-expo on Node 24.
- **`jest.mock()` must come before imports:** In Jest, mock declarations are hoisted but only if they appear before the `import` statements in the file
- **`jest.resetModules()` is essential for redis.test.ts and trainCache.test.ts:** These modules have module-level state (in-memory stores) that persists between tests unless you reset the module registry
- **Zustand's `setState` works great for test reset:** `useTrainStore.setState({...initialState})` in `beforeEach` is the cleanest way to reset Zustand stores
- **Watchman recrawl warnings:** Harmless but noisy. Can be fixed with `watchman watch-del '/Users/StephenLear/Projects/locosnap' ; watchman watch-project '/Users/StephenLear/Projects/locosnap'`

## Next Steps (Prioritized)
1. **Push to GitHub** and verify CI workflow runs green on first push
2. **Add Upstash Redis** — create free Upstash instance, add `REDIS_URL` to Render env vars
3. **Add `--forceExit` to frontend test script** — currently the `pollBlueprintStatus` cancel test leaves an open handle (the `Force exiting Jest` warning)
4. **Consider component tests** — when Expo/jest-expo catches up to Node 24, add `.tsx` rendering tests for key screens
5. **Coverage reporting** — add `--coverage` flag and coverage thresholds to CI
6. **Add `.env.test`** for backend test config instead of inline `jest.mock("../../config/env")`

## Important Files
| File | Role |
|------|------|
| `backend/src/services/redis.ts` | NEW: Redis blueprint task store with in-memory fallback |
| `backend/src/services/imageGen.ts` | MODIFIED: Now uses async Redis operations instead of local Map |
| `backend/src/config/env.ts` | MODIFIED: Added `redisUrl` and `hasRedis` config |
| `backend/src/index.ts` | MODIFIED: Added `initRedis()`, removed `cleanupOldTasks` interval |
| `backend/src/routes/imageStatus.ts` | MODIFIED: Async handler, `await getTaskStatus()` |
| `backend/src/routes/identify.ts` | MODIFIED: `await getTaskStatus()` in monitorBlueprintForCache |
| `backend/jest.config.ts` | Backend Jest config (ts-jest, node env) |
| `backend/src/__tests__/fixtures.ts` | Test fixture factories (makeTrain, makeSpecs, etc.) |
| `backend/src/__mocks__/env.ts` | Mock env config for tests |
| `frontend/jest.config.js` | Frontend Jest config (ts-jest, node env, pure logic tests) |
| `frontend/utils/compare.ts` | NEW: Extracted parseNumeric + compareValues from compare.tsx |
| `frontend/app/compare.tsx` | MODIFIED: Now imports from utils/compare.ts |
| `frontend/__tests__/store/trainStore.test.ts` | Zustand store tests with comprehensive dependency mocks |
| `frontend/__tests__/services/api.test.ts` | API client tests (modified by linter — cancel test approach) |
| `.github/workflows/ci.yml` | NEW: CI workflow — backend + frontend tests on push |
| `.github/workflows/preview.yml` | NEW: EAS preview build on frontend PRs |
| `CLAUDE.md` | REWRITTEN: CarSnap -> LocoSnap, accurate project docs |
| `docs/plans/2026-02-14-hardening-plan.md` | The 27-task hardening plan that was executed |

## Context for Next Session
- **Git branch:** `main` — all work was committed directly to main (8 commits in this hardening phase)
- **Git status:** Clean working tree (only untracked: `docs/handoffs/HANDOVER-2026-02-13.md`)
- **Node version:** 24 locally, CI pinned to 20
- **All tests pass:** `backend: npm test` (53 tests) + `frontend: npm test` (39 tests)
- **TypeScript compiles:** `cd backend && npx tsc --noEmit` passes clean
- **The `api.test.ts` file was modified by a linter** after the last commit — the cancel test approach remains the same but formatting may differ. This is fine and should be committed in the next session if there are changes.
